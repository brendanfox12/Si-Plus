title: "CodeRed_Module7"
author: "Liz Asprinio, Tingwei Hu, James Kim, Justin Lau"
date: "2022-11-27"
output: html_document
bibliography: BIOL3140_m7.bib
nocite: '@*'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```
```{r, packages, include=FALSE}
library(tidyverse)
library(knitr)
library(MuMIn)
```
# Introduction
The muscle force-length relationship is governed by several factors. One aspect is the number of crossbridges formed in the regions of actin-myosin overlap of a sarcomere, which is directly related to the maximum amount of isometric force that can be produced by the muscle. Another aspect is mechanical advantage, the ratio between input (L_i) and output (L_o) force:
				$$MA = L_i/L_o$$
Greater mechanical advantage is described by a smaller ratio, or moving a load using a relatively small force. In the human body, this concept is illustrated by bones and joints acting as levers and pivots to minimize the force required by muscles to move a load. The arm is a lever and has a mechanical advantage of 0.2. However, the insertion angle of the muscles changes as the forearm flexes, which also contributes to output force. This complicates the study of force-length relationships, but research has shown that output force is sufficient to determine force-length relationships in input muscles (@rassier1999length).
In this project, the force-length relationship in the human arm and its response to fatigue will be studied. Isometric force-angle curves for the human forearm flexors undertaking maximum voluntary contractions (MVCs) will be constructed, and the angles at which maximum isometric force (Fmax) occur (Î¸max) between non-fatigued (i.e., control) and eccentrically fatigued forearm flexors will be compared.Research has shown that the force-length/angle relationship shifts after eccentric fatigue, and the underlying mechanisms of this shift will be discussed.
last few sentences r exactly from his writing so ill fix them up


# Methods
Still under construction.
Maximum isometric voluntary contraction force was measured for each subject (n=34) at 11-12 different elbow angles (range:45 to 157.5 degrees, in varying increments) for both fatigue and control conditions. Fatigue was considered reached after performing 3 minutes of continuous isokinetic controlled drops of a heavy object, which weights >=1/3 of maximum isometric force in control experiment. Both the control and fatigue experiments were conducted on the same arm in each respective subject. 
We first normalized isometric force in each subject by representing the force at each angle as a fraction of the highest force measured in that subject under the same condition. 
Maximum isometric voluntary contraction force was measured for each subject (n=34) at 11-12 different elbow angles (range:45 to 157.5 degrees, in varying increments) for both fatigue and control conditions. Fatigue was considered reached after performing 3 minutes of continuous isokinetic controlled drops of a heavy object, which weights >=1/3 of maximum isometric force in control experiment. Both the control and fatigue experiments were conducted on the same arm in each respective subject.  
We first normalized isometric force in each trial by representing the force at each angle as a fraction of the highest force measured in that subject under the same condition. We then conducted model fitting using second, third, and fourth order for force and angle relationship, and calculated the AIC scores for each combination of subject and experiment. We also predicted maximum elbow angle at which maximum MVC force occurs (theta_max) using all three models mentioned above. Then, we kept only the theta_max values corresponding to the best fitting model in each condition. Lastly, we conducted an analysis of variance (ANOVA) to check whether mean theta_max differ significantly between fatigue and control conditions, and then calculated the mean and SEM of shift in theta_max. 
```{r, Read files and data tidying,message=FALSE}
dat.f <- list.files(path="./Project-8_data") #pls don't move the data folder
@@ -54,27 +53,82 @@ for(i in dat.f){
  )
}
dat <- do.call(rbind,dat.l)
#This took an ungodly amount of time to figure out...
dat.p <- dat %>% #processing all the data
  group_by(exp,subject) %>% 
  mutate(force=force/max(force)) %>% 
  print() #sanity check
```

#This took an ungodly amount of time to figure out...
```{r,cleanup,include=FALSE}
dat.p2 <- dat.p %>% 
  na.omit()
```

```{r, AIC fitting, message=FALSE}
AICs <- dat.p2%>%
  group_by(subject,exp)%>%
  summarize(
    m2=AICc(lm(force~poly(ang,2))), #second order
    m3=AICc(lm(force~poly(ang,3))), #third order
    m4=AICc(lm(force~poly(ang,4))) #fourth order
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="AICc")
```

```{r, theta max, message=FALSE}
x.pred <- seq(45,157.5,length.out = 1000)
fits <- dat.p2%>%
  group_by(subject,exp)%>%
  summarize(
    m2=predict(lm(force~poly(ang,2)),newdata=data.frame(ang=x.pred)), #second order
    m3=predict(lm(force~poly(ang,3)),newdata=data.frame(ang=x.pred)), #third order
    m4=predict(lm(force~poly(ang,4)),newdata=data.frame(ang=x.pred)) #fourth order
  )%>%
   pivot_longer(m2:m4,names_to="model")%>%
   group_by(subject,exp,model)%>%
   summarize(theta_max=x.pred[which.max(value)])
```

# Results
Visualizing normalized data.
```{r, plotting data}
dat.p %>%
  na.omit() %>% 
dat.p2 %>%
  ggplot(aes(ang,force,col=exp))+geom_point() #visualize
```

Model prediction filtered by best fit.
```{r,model prediction filtered by best fit, message=FALSE}
best.models <- fits%>%
  left_join(AICs)%>%
  group_by(subject,exp)%>%
  mutate(best=AICc==min(AICc))%>%
  filter(best==TRUE)%>%
  dplyr::select(-best)%>%
  print()
```

ANOVA for theta_max in fatigue and control conditions. 
```{r,anova}
anova(lm(theta_max~exp,best.models))
```

Mean shift and SEM of shift. 
```{r, mean shift & SE}
best.models%>%
  pivot_wider(id_cols=subject,names_from = exp,values_from=theta_max)%>%
  mutate(shift=fatigue-control) %>% 
  ungroup() %>%
  na.omit() %>% 
  summarise(mean.shift=mean(shift),se.shift=sd(shift)/sqrt(length(shift)))
```

# Discussion



# Author Contribution
Tingwei Hu - Doc setup, read files, plot initial data, methods
Tingwei Hu - Setup, read files, plot initial data, data analysis code in methods and results


